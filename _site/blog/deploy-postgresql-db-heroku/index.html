<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Essi Alizadeh">
<meta name="dcterms.date" content="2021-06-26">

<title>Essi Alizadeh - Step-by-Step Deployment of a Free PostgreSQL Database And Data Ingestion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-180647948-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>
<style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Essi Alizadeh - Step-by-Step Deployment of a Free PostgreSQL Database And Data Ingestion">
<meta property="og:description" content="PostgreSQL: a free and open-source object-relational database management system that emphasizes extensibility and SQL compliance.">
<meta property="og:image" content="https://ealizadeh.com/blog/deploy-postgresql-db-heroku/img/_featured_image.png">
<meta property="og:site-name" content="Essi Alizadeh">
<meta property="og:image:height" content="1453">
<meta property="og:image:width" content="1944">
<meta name="twitter:title" content="Essi Alizadeh - Step-by-Step Deployment of a Free PostgreSQL Database And Data Ingestion">
<meta name="twitter:description" content="PostgreSQL: a free and open-source object-relational database management system that emphasizes extensibility and SQL compliance.">
<meta name="twitter:image" content="https://ealizadeh.com/blog/deploy-postgresql-db-heroku/img/_featured_image.png">
<meta name="twitter:creator" content="@es_alizadeh">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image-height" content="1453">
<meta name="twitter:image-width" content="1944">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Essi Alizadeh</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html">Blog</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">About</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Step-by-Step Deployment of a Free PostgreSQL Database And Data Ingestion</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">Database</div>
                <div class="quarto-category">Guide to</div>
                <div class="quarto-category">Python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Essi Alizadeh </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 26, 2021</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#in-this-post-you-will-learn-how-to" id="toc-in-this-post-you-will-learn-how-to" class="nav-link active" data-scroll-target="#in-this-post-you-will-learn-how-to">In this post, you will learn how to …</a></li>
  <li><a href="#one-line-summary-of-related-technologies" id="toc-one-line-summary-of-related-technologies" class="nav-link" data-scroll-target="#one-line-summary-of-related-technologies">One-line summary of related technologies</a></li>
  <li><a href="#prerequisite" id="toc-prerequisite" class="nav-link" data-scroll-target="#prerequisite">Prerequisite</a></li>
  <li><a href="#heroku-signup-and-deployment" id="toc-heroku-signup-and-deployment" class="nav-link" data-scroll-target="#heroku-signup-and-deployment">Heroku Signup and Deployment</a>
  <ul>
  <li><a href="#sign-up-to-heroku-deploy-your-first-postgresql-database" id="toc-sign-up-to-heroku-deploy-your-first-postgresql-database" class="nav-link" data-scroll-target="#sign-up-to-heroku-deploy-your-first-postgresql-database">1. Sign up to Heroku &amp; Deploy Your First PostgreSQL Database</a></li>
  <li><a href="#access-your-heroku-account-using-token" id="toc-access-your-heroku-account-using-token" class="nav-link" data-scroll-target="#access-your-heroku-account-using-token">2. Access your Heroku account using Token</a>
  <ul class="collapse">
  <li><a href="#generate-a-heroku-api-token" id="toc-generate-a-heroku-api-token" class="nav-link" data-scroll-target="#generate-a-heroku-api-token">2.1. Generate a Heroku API Token</a></li>
  <li><a href="#store-your-heroku-token-in-your-environment" id="toc-store-your-heroku-token-in-your-environment" class="nav-link" data-scroll-target="#store-your-heroku-token-in-your-environment">2.2. Store your Heroku token in your environment</a></li>
  <li><a href="#retrieve-heroku-postgresql-database-url" id="toc-retrieve-heroku-postgresql-database-url" class="nav-link" data-scroll-target="#retrieve-heroku-postgresql-database-url">2.3 Retrieve Heroku PostgreSQL Database URL</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data-ingestion-to-a-table" id="toc-data-ingestion-to-a-table" class="nav-link" data-scroll-target="#data-ingestion-to-a-table">Data Ingestion to a&nbsp;Table</a>
  <ul>
  <li><a href="#create-sqlalchemy-engine" id="toc-create-sqlalchemy-engine" class="nav-link" data-scroll-target="#create-sqlalchemy-engine">Create SQLAlchemy Engine</a></li>
  <li><a href="#ingest-data-using-pandas-sqlalchemy" id="toc-ingest-data-using-pandas-sqlalchemy" class="nav-link" data-scroll-target="#ingest-data-using-pandas-sqlalchemy">Ingest Data using Pandas &amp; SQLAlchemy</a></li>
  </ul></li>
  <li><a href="#additional-tips" id="toc-additional-tips" class="nav-link" data-scroll-target="#additional-tips">Additional Tips</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#useful-links" id="toc-useful-links" class="nav-link" data-scroll-target="#useful-links">Useful Links</a></li>
  <li><a href="#related-posts" id="toc-related-posts" class="nav-link" data-scroll-target="#related-posts">Related posts</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><img src="img/_featured_image.png" class="img-fluid"></p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>👉 This article is also published on&nbsp;<strong><a href="https://towardsdatascience.com/deploy-free-postgresql-database-in-heroku-and-ingest-data-8002c574a57d">Towards Data Science blog</a></strong>.</p>
</div>
</div>
<section id="in-this-post-you-will-learn-how-to" class="level3">
<h3 class="anchored" data-anchor-id="in-this-post-you-will-learn-how-to">In this post, you will learn how to …</h3>
<ul>
<li><em>Deploy a free PostgreSQL database in Heroku</em></li>
<li><em>Generate a Heroku API token (in two ways)</em></li>
<li><em>Dynamically retrieve Heroku database URL (useful to overcome a shortcoming of the free plan)</em></li>
<li>Ingest data to <em>a table in the database using Pandas and SQLAlchemy</em></li>
<li><em>Specify data type of columns in the table using SQLAlchemy datatypes</em></li>
</ul>
</section>
<section id="one-line-summary-of-related-technologies" class="level2">
<h2 class="anchored" data-anchor-id="one-line-summary-of-related-technologies">One-line summary of related technologies</h2>
<p><a href="https://www.postgresql.org/">PostgreSQL</a>: a free and open-source object-relational database management system that emphasizes extensibility and SQL compliance.</p>
<p><a href="https://www.heroku.com/">Heroku</a>: a platform as a service (PaaS) suitable for quick deployments with minimal needed DevOps experience.</p>
<p><a href="https://www.sqlalchemy.org/">SQLAlchemy</a>: a Python SQL library and Object Relational Mapper (ORM) to interact with databases.</p>
<p><a href="https://pandas.pydata.org/">Pandas</a>: An open-source Python library for data analysis and manipulation.</p>
</section>
<section id="prerequisite" class="level1">
<h1>Prerequisite</h1>
<p>You will need the following Python libraries</p>
<ul>
<li><a href="https://pandas.pydata.org/">pandas</a></li>
<li><a href="https://pandas.pydata.org/">psycopg2</a></li>
<li><a href="https://www.sqlalchemy.org/">SQLAlchemy</a></li>
</ul>
<p>And also</p>
<ul>
<li><a href="https://devcenter.heroku.com/articles/heroku-cli">Heroku CLI</a> (verify your installation by entering <code>heroku --version</code> in the terminal)</li>
</ul>
<hr>
</section>
<section id="heroku-signup-and-deployment" class="level1">
<h1>Heroku Signup and Deployment</h1>
<p>Heroku is a platform as a service (PaaS) that enables developers to build and run applications entirely in the cloud. Heroku offers a ready-to-use environment that makes it very simple to deploy your code as quickly as possible with little development experience. This is an excellent choice for beginners and small to medium-sized companies, unlike AWS, which usually requires experienced developers and has complicated deployment processes.</p>
<section id="sign-up-to-heroku-deploy-your-first-postgresql-database" class="level2">
<h2 class="anchored" data-anchor-id="sign-up-to-heroku-deploy-your-first-postgresql-database">1. Sign up to Heroku &amp; Deploy Your First PostgreSQL Database</h2>
<p>You can <a href="https://signup.heroku.com/">signup</a> for free to Heroku. After signing up and logging into your account, you will be directed to the Heroku Dashboard. Then, you can follow the instructions in the following clip to create a new app and add a PostgreSQL database.</p>
<!-- [Deploy a new Heroku app and add the PostgreSQL driver](Step-by-Step%20Deployment%20of%20a%20Free%20PostgreSQL%20Datab%20c6565be042204579af1564b8f7be1c3f/) -->
<div class="ratio ratio-16x9"><iframe src="https://player.vimeo.com/video/754955742" frameborder="0" allow="autoplay; title=" "="" fullscreen;="" picture-in-picture"="" allowfullscreen=""></iframe></div>
<p>The free plan allows you to have a maximum of 20,000 rows of data and up to 20 connections to the database. This plan is usually enough for a small personal project.</p>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Danger
</div>
</div>
<div class="callout-body-container callout-body">
<p>In the free plan, the database credentials will occasionally change since Heroku rotates credentials periodically and sometimes perform maintenances.</p>
</div>
</div>
<p>To address the issue of occasional changes in the database credentials, we can use Heroku CLI to retrieve the database URL dynamically. But first, let’s go over the procedure for logging in to your account via Heroku CLI.</p>
</section>
<section id="access-your-heroku-account-using-token" class="level2">
<h2 class="anchored" data-anchor-id="access-your-heroku-account-using-token">2. Access your Heroku account using Token</h2>
<p>What’s covered in this section is applicable in general for working with any Heroku applications through <strong>Heroku CLI</strong>.</p>
<section id="generate-a-heroku-api-token" class="level3">
<h3 class="anchored" data-anchor-id="generate-a-heroku-api-token">2.1. Generate a Heroku API Token</h3>
<p>You can generate the token in the following two ways:</p>
<p><strong>2.1.1. Heroku account (browser)</strong></p>
<p>Go to <strong>Account settings → Applications</strong>. Under the <strong>Authorizations</strong> section, click on <strong>Create authorization</strong>. You have to give a description in the opened window and set the expiry time or just set no expiry for the token (by leaving the box blank).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/heroku_token_generation_web-app.png" class="img-fluid figure-img" alt="Create a Heroku API token from Heroku dashboard"></p>
<p></p><figcaption class="figure-caption">Create a Heroku API token from Heroku dashboard</figcaption><p></p>
</figure>
</div>
<p><strong>2.1.2. Heroku CLI (terminal)</strong></p>
<p>After installing the Heroku CLI, the first time you try to use a command that requires access to your account, you will be prompted to log in to your Heroku account on your browser. Once you’re logged in, you can do almost anything through the Heroku API. For example, we can create a token by running the following:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="va">$heroku</span> authorization:create</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The above command will generate a long-lived token for you. The first time you run the above command, you will be prompted to log in to your account in a browser. Once you successfully log into your account, you can get back to the terminal and see the generated token, as shown below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/heroku_token_generation_cli.png" class="img-fluid figure-img" alt="Generate a Heroku API token via Heroku CLI"></p>
<p></p><figcaption class="figure-caption">Generate a Heroku API token via Heroku CLI</figcaption><p></p>
</figure>
</div>
</section>
<section id="store-your-heroku-token-in-your-environment" class="level3">
<h3 class="anchored" data-anchor-id="store-your-heroku-token-in-your-environment">2.2. Store your Heroku token in your environment</h3>
<p>Now that you have your Heroku API token, you need to set it in your terminal/environment as <code>HEROKU_API_KEY</code>. You can achieve this by running the following in your terminal:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">HEROKU_API_KEY</span><span class="op">=&lt;</span>your_token<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>A variable set in the shell terminal will only be available in the terminal from which you ran and will die after closing it. Instead, you can put above command in your <code>~/.bash</code> or <code>~/.bashrc</code> file so that the variable will be available in any new terminal you open. This way, you don’t need to worry about setting this variable again!</p>
</div>
</div>
<p>Once you have <code>HEROKU_API_KEY</code> variable set in your terminal, you no longer need to use the web-based authentication or username and password to log in. This is particularly important if you want to use Heroku CLI as a part of an automation process or CI/CD. This way, you don’t need to log in each time and use the token in any different terminals.</p>
</section>
<section id="retrieve-heroku-postgresql-database-url" class="level3">
<h3 class="anchored" data-anchor-id="retrieve-heroku-postgresql-database-url">2.3 Retrieve Heroku PostgreSQL Database URL</h3>
<p>You can get the database URL by running the following command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">$heroku</span> config:get DATABASE_URL <span class="at">--app</span> <span class="op">&lt;</span>your-app-name<span class="op">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will output the database URL in the format of</p>
<p><code>postgres://&lt;db_user&gt;:&lt;db_password&gt;@&lt;db_host&gt;/&lt;db_name&gt;</code></p>
<p>We can use Python’s standard library <a href="https://docs.python.org/3/library/subprocess.html">subprocess</a> to run above command and retrieve the database credentials. This way we will have all our codes in Python!</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>heroku_app_name <span class="op">=</span> <span class="st">"your-app-name"</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>raw_db_url <span class="op">=</span> subprocess.run(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"heroku"</span>, <span class="st">"config:get"</span>, <span class="st">"DATABASE_URL"</span>, <span class="st">"--app"</span>, heroku_app_name],</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    capture_output<span class="op">=</span><span class="va">True</span>  <span class="co"># capture_output arg is added in Python 3.7</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>).stdout </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout-important callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Your Python (iPython) terminal/environment should have <code>HEROKU_API_KEY</code> set. You can verify that by running <code>os.environ["HEROKU_API_KEY"]</code> and verifying the token in the output.</p>
</div>
</div>
<hr>
</section>
</section>
</section>
<section id="data-ingestion-to-a-table" class="level1">
<h1>Data Ingestion to a&nbsp;Table</h1>
<section id="create-sqlalchemy-engine" class="level2">
<h2 class="anchored" data-anchor-id="create-sqlalchemy-engine">Create SQLAlchemy Engine</h2>
<p>Before we ingest data to a table in the deployed PostgreSQL database using Pandas, we have to create an SQLAlchemy engine that will be passed to the Pandas method. The SQLAlchemy engine/connection can be created using the following code snippet:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.engine.create <span class="im">import</span> create_engine</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the Database URL using Heroku CLI</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Running the following from Python: $heroku config:get DATABASE_URL --app your-app-name</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>heroku_app_name <span class="op">=</span> <span class="st">"your-app-name"</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Assumption: HEROKU_API_KEY is set in your terminal</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># You can confirm that it's set by running the following python command os.environ["HEROKU_API_KEY"]</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>raw_db_url <span class="op">=</span> subprocess.run(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"heroku"</span>, <span class="st">"config:get"</span>, <span class="st">"DATABASE_URL"</span>, <span class="st">"--app"</span>, heroku_app_name],</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    capture_output<span class="op">=</span><span class="va">True</span>  <span class="co"># capture_output arg is added in Python 3.7</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>).stdout </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert binary string to a regular string &amp; remove the newline character</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>db_url <span class="op">=</span> raw_db_url.decode(<span class="st">"ascii"</span>).strip()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert "postgres://&lt;db_address&gt;"  --&gt; "postgresql+psycopg2://&lt;db_address&gt;" needed for SQLAlchemy</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>final_db_url <span class="op">=</span> <span class="st">"postgresql+psycopg2://"</span> <span class="op">+</span> db_url.lstrip(<span class="st">"postgres://"</span>)  <span class="co"># lstrip() is more suitable here than replace() function since we only want to replace postgres at the start!</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Create SQLAlchemy engine</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>engine <span class="op">=</span> create_engine(final_db_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>As you may note in the above, some string manipulation is required before creating the SQLAlchemy engine.</p>
</section>
<section id="ingest-data-using-pandas-sqlalchemy" class="level2">
<h2 class="anchored" data-anchor-id="ingest-data-using-pandas-sqlalchemy">Ingest Data using Pandas &amp; SQLAlchemy</h2>
<p>We can ingest the data into a table by simply using pandas <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_sql.html"><code>to_sql()</code></a> function and passing the SQLAlchemy engine/connection object to it.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sqlalchemy.types <span class="im">import</span> Integer, DateTime</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>DATA_URL <span class="op">=</span> <span class="st">"https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/latest/owid-covid-latest.csv"</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(DATA_URL)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df.to_sql(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covid19"</span>,  <span class="co"># table name</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">'replace'</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span>,  <span class="co"># In order to avoid writing DataFrame index as a column</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    dtype<span class="op">=</span>{</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"last_updated_date"</span>: DateTime(),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_cases"</span>: Integer(),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"new_cases"</span>: Integer()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the above example, the data type of few columns is specified. You can determine the dtype of columns by passing a dictionary in which keys should be the column names and the values should be the SQLAlchemy types. For all available dtypes, you can check SQLAlchemy <a href="https://docs.sqlalchemy.org/en/14/core/type_basics.html">documentation</a> for the data types it supports.</p>
</section>
</section>
<section id="additional-tips" class="level1">
<h1>Additional Tips</h1>
<p>Reading data into a Pandas dataframe using pandas <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_sql_table.html"><code>read_sql_table()</code></a>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_sql_table(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"covid19"</span>,  <span class="co"># table name</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can run raw SQL queries using SQLAlchemy’s <a href="https://docs.sqlalchemy.org/en/14/core/engines.html#sqlalchemy.create_engine"><code>.execute("&lt;your SQL query&gt;")</code></a> function. For instance, if you want to drop the above table by running a SQL query, you can do so by doing the following:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>engine.execute(<span class="st">"DROP TABLE covid19"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Above will create an SQLAlchemy cursor.</p>
<hr>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>In this post, we deployed a free PostgreSQL database using Heroku free plan. We also addressed the issue of changing database credentials by Heroku in the free plan by retrieving the database credentials dynamically via Heroku CLI. Using Pandas’ <code>to_sql()</code> function, we quickly created a table and even specified data types of columns via SQLAlchemy data types.</p>
<hr>
</section>
<section id="useful-links" class="level1">
<h1>Useful Links</h1>
<p><a href="https://devcenter.heroku.com/articles/authentication">Heroku CLI Authentication</a></p>
<p><a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.to_sql.html">pandas.DataFrame.to_sql - pandas 1.2.5 documentation</a></p>
<p><a href="https://docs.sqlalchemy.org/en/14/core/type_basics.html">SQLAlchemy 1.4 Documentation</a></p>
</section>
<section id="related-posts" class="level1">
<h1>Related posts</h1>
<p><a href="https://towardsdatascience.com/how-to-deploy-a-postgres-database-for-free-95cf1d8387bf">How To Deploy A Postgres Database For Free</a></p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{alizadeh2021,
  author = {Essi Alizadeh},
  editor = {},
  title = {Step-by-Step {Deployment} of a {Free} {PostgreSQL} {Database}
    {And} {Data} {Ingestion}},
  date = {2021-06-26},
  url = {https://ealizadeh.com/blog/deploy-postgresql-db-heroku},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-alizadeh2021" class="csl-entry quarto-appendix-citeas" role="doc-biblioentry">
Essi Alizadeh. 2021. <span>“Step-by-Step Deployment of a Free PostgreSQL
Database And Data Ingestion.”</span> June 26, 2021. <a href="https://ealizadeh.com/blog/deploy-postgresql-db-heroku">https://ealizadeh.com/blog/deploy-postgresql-db-heroku</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">©️ 2022 Esmaeil Alizadeh - All Rights Reserved</div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/e-alizadeh">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/es_alizadeh">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>



<script src="../../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>